<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ğŸˆFind your Base:)-ì¥ë°”êµ¬ë‹ˆ</title>
    <link rel="stylesheet" th:href="@{/css/cart.css}">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <!--  í°íŠ¸-->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jua&family=Nanum+Gothic&family=Noto+Sans+KR&display=swap"
          rel="stylesheet">
</head>
<body style="background-color: white">
<th:block th:replace="commonPages/header :: header"></th:block>

<div class="main">
    <div th:unless="${cartList == null}" class="cart_table">
        <p>ì¥ë°”êµ¬ë‹ˆğŸ›’</p>

        <ul class="cart_list">
            <li>
                <div class="checkbox">
                    <input type="checkbox" name="all_chk" id="all_chk" checked th:onclick="checkAll([[${cartList}]])">
                    <label for="all_chk">ì „ì²´ì„ íƒ</label>
                </div>
                <!--            <div class="del_btn">ì‚­ì œ (<span class="num">0</span>)</div>-->
            </li>
            <li th:each="cart:${cartList}">
<!--                ì²´í¬ë°•ìŠ¤-->
                <div class="checkbox">
                    <input type="checkbox" th:id="${cart.id}" checked th:value="${cart.id}" name="item_chk"
                           th:onclick="checkBox([[${cart} ]])">
                    <label th:for="${cart.id}"></label>
                </div>
<!--                ë‹´ì€ ìƒí’ˆ-->
                <div class="item_detail">
                    <img th:src="@{|/upload/${cart.itemImage}}" alt="" width="50" height="50" style="width: 50px">
                    <p class="name"><strong th:text="${cart.itemName}"></strong></p>
                    <!--                <p class="txt">í…ìŠ¤íŠ¸</p>-->
                </div>
<!--                ì„ íƒí•œ ì˜µì…˜-->
                <div class="opt_info">
                    <strong class="price_unit" th:text="${#numbers.formatInteger(cart.itemPrice,0,'COMMA')}"></strong>ì›
                    <!--                <strong class="price_unit" th:text="${cart.itemPrice}"></strong>ì›-->
                    <input class="number" type="number" th:id="${cart.id}+'a'" min="1" max="100"
                           th:value="${cart.cartCount}"
                           name="orderCount" th:onchange="total([[${cart}]])">
                    <div class="total_p">
                        <input type="hidden" class="price_amount" th:id="${cart.id+'price_amount'}" name="price_amount"
                               th:value="${cart.itemPrice}*${cart.cartCount}">
                        <strong th:id="${cart.id+'price_amount2'}" th:value="${cart.itemPrice}*${cart.cartCount}"
                                th:text="|${#numbers.formatInteger(cart.itemPrice*cart.cartCount,0,'COMMA')}|"></strong>ì›
<!--                        ë‹´ì€ ìƒí’ˆ ì‚­ì œ-->
                        <span class="del_li_btn">
                            <img
                                    th:src="@{https://tictoc-web.s3.ap-northeast-2.amazonaws.com/web/img/icon/btn_del_circle.svg}"
                                    th:onclick="deleteFn([[${cart}]])">
                        </span>
                    </div>
                </div>
            </li>
        </ul>
    </div>

    <input type="hidden" id="cartList" th:if="${cartList}" th:value="${cartList.size()}">

    <div class="cart_table">
        <div class="cart_total_area">
            <p>ê²°ì œ ì •ë³´</p>
            <div class="cart_total_price">
                <p>ì´ ê²°ì œê¸ˆì•¡ <strong class="item_price_total" id="item_price_total"></strong>ì› <span class="plus_ic"></span>
                </p>
            </div>
        </div>

        <div class="btn_box">
            <button type="button" onclick="goBack()" class="btn wh-btn">ê³„ì† ì‡¼í•‘í•˜ê¸°</button>
            <button type="button" onclick="orderFn()" class="btn black-btn">êµ¬ë§¤í•˜ê¸°</button>
        </div>

    </div>
</div>
</body>

<script th:inline="javascript">
    //ì „ì²´ì²´í¬ë°•ìŠ¤
    const checkAll = (cartList) => {
        const length = document.getElementById("cartList").value;
        console.log("checkBox")
        const allChk = document.getElementById('all_chk');
        if (allChk.checked == true) {
            for (let i = 0; i < length; i++) {
                document.getElementById(cartList[i].id).checked = true;
            }
            checkPrice();
        } else {
            allChk.checked = false;
            for (let i = 0; i < length; i++) {
                document.getElementById(cartList[i].id).checked = false;
            }
            document.querySelector(".item_price_total").innerHTML = 0;
            checkPrice();
        }
    }

    //ì²´í¬ë°•ìŠ¤
    const checkBox = (cart) => {
        console.log("checkë°•ìŠ¤ í´ë¦­")
        const length = document.getElementById("cartList").value;
        let checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
        const allChk = document.getElementById('all_chk');
        if (checkboxes.length-1 == length) {
            allChk.checked = true;
        } else {
            allChk.checked = false;
        }
        console.log("ì²´í¬ë°•ìŠ¤ ì´í”„ë¬¸ ì‹¤í–‰ì™„ë£Œ")
        checkPrice();
    }


    //ê³„ì† ì‡¼í•‘í•˜ê¸°
    const goBack = () => {
        location.href = "/item/main";
    }

    //ì£¼ë¬¸í•˜ê¸°
    const orderFn = () => {

        let itemPriceTotal2 = document.querySelector(".item_price_total").innerHTML;
        let itemPriceTotal = itemPriceTotal2.replace(/,/g, '');
        console.log("ì •ê·œì‹í™•ì¸" + itemPriceTotal)

        const length = document.getElementById("cartList").value;
        console.log("ì£¼ë¬¸í•˜ê¸°");
        const cartList = [[${cartList}]];
        if (itemPriceTotal == 0) {
            alert("ì£¼ë¬¸í•  ìƒí’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”");
            return;
        }

        if (cartList.length == 0) {
            alert("ì¥ë°”êµ¬ë‹ˆì— ë‹´ê¸´ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤ğŸ˜°");
        } else {
            const userId = [[${session.member.userId}]];
            let cartIdList = [[${cartIdList}]];
            let aJsonArray = new Array();
            for (let i = 0; i < length ; i++) {
                let b = document.getElementById(cartList[i].id)
                console.log(b.checked)
                if(b.checked == true){
                    aJson = new Object();
                    aJson.cartItemId = cartList[i].id;
                    aJson.itemName = cartList[i].itemName;
                    aJson.itemPrice = cartList[i].itemPrice;
                    aJson.cartCount = document.getElementById(cartList[i].id + "a").value;
                    aJson.itemImage = cartList[i].itemImage;
                    aJson.itemPriceTotal = itemPriceTotal;
                    aJsonArray.push(aJson);
                }
            }
            console.log(aJsonArray);
            $.ajax({
                type: "post",
                url: "/order/cart2",
                data: {
                    "cartList": JSON.stringify(aJsonArray)
                },
                dataType: "text",
                success: function (result) {
                    if (result == "ok"){
                        location.href = "/order/cart3?userId="+userId;
                    }else {
                        alert("ì´ì „ ì£¼ë¬¸ë‚´ì—­ì´ ì¡´ì¬í•©ë‹ˆë‹¤. ì£¼ë¬¸í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
                        location.href = "/order/cart3?userId="+userId;
                    }

                },
                error: function (err) {
                    console.log("ì‹¤íŒ¨");
                }
            });
            // location.href = "/order/cart?userId=" + userId + "&itemPriceTotal=" + itemPriceTotal;
        }

    }
    //ì¥ë°”êµ¬ë‹ˆ ì‚­ì œ
    const deleteFn = (find) => {
        const length = document.getElementById("cartList").value;
        console.log(length);
        const id = find.id;
        const itemPrice = find.itemPrice;
        let itemPriceTotal = 0;
        const cartList = [[${cartList}]];
        for (let i = 0; i < length; i++) {
            itemPriceTotal += cartList[i].itemPrice * cartList[i].cartCount;
        }

        $.ajax({
            type: "get",
            url: "/cart/delete",
            data: {
                cartId: id
            },
            dataType: "text",
            success: function (cartResult) {
                console.log(id)
                console.log(cartResult);
                document.querySelector(".item_price_total").innerHTML = itemPriceTotal - itemPrice;
                document.getElementById("cartList").value = length - 1;
                location.href= "/cart/list?userId="+[[${session.member.userId}]];
            },
            error: function () {
                console.log("ì‹¤íŒ¨");

            }
        });
    }
    //ê³„ì‚°
    const checkPrice = () => {
        console.log("ì´ ìƒí’ˆê¸ˆì•¡");
        const length = document.getElementById("cartList").value;
        let checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
        const allChk = document.getElementById(
            'all_chk');
        console.log(checkboxes);
        const cartList2 = [[${cartList}]];
        let sum = 0;
        for (let i = 0; i < length; i++) {
            if (document.getElementById(cartList2[i].id).checked == true) {
                sum += Number(document.getElementById(cartList2[i].id + 'price_amount').value);
                //ì´ ìƒí’ˆê¸ˆì•¡ì— ì½¤ë§ˆì°ê¸°
                const money = Number(sum).toLocaleString();
                document.querySelector(".item_price_total").innerHTML = money;
            }
        }
        if (checkboxes.length == 0 && allChk.checked == true) {
            document.querySelector(".item_price_total").innerHTML = 0;
            allChk.checked = false;
        }else if(checkboxes.length == 0){
            document.querySelector(".item_price_total").innerHTML = 0;
        }
    }


    //ì´ ìƒí’ˆê¸ˆì•¡
    window.onload = function () {
        checkPrice();
    }


    //ìˆ˜ëŸ‰ë³€ê²½ ì‹œ ìƒí’ˆê¸ˆì•¡
    const total = (cart) => {
        let orderCount = document.getElementById(cart.id + "a").value;
        $.ajax({
            type: "get",
            url: "/cart/change",
            data: {
                id: cart.id,
                cartCount: orderCount
            },
            dataType: "text",
            success: function (cartResult) {
                console.log("ì„±ê³µ")
            },
            error: function () {
                console.log("ì‹¤íŒ¨");

            }
        });
        const length = document.getElementById("cartList").value;
        console.log(cart)
        const itemPrice2 = cart.itemPrice;
        let itemPrice = itemPrice2;
        let totalPrice = orderCount * itemPrice;
        let a = document.getElementsByName("price_amount")[0].value;
        console.log(a);

        document.getElementById(cart.id + "price_amount").value= totalPrice;
        const money = Number(totalPrice).toLocaleString();
        document.getElementById(cart.id + "price_amount2").textContent = money;
        let itemPriceTotal = 0;
        for (let i = 0; i < length; i++) {
            itemPriceTotal += Number(document.getElementsByName("price_amount")[i].value);
        }
        console.log(itemPriceTotal)
        document.querySelector(".item_price_total").innerHTML = itemPriceTotal;
        checkPrice();
    }

</script>

</html>