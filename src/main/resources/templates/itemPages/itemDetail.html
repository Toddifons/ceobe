<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ğŸˆFind your Base:)-ìƒì„¸ë³´ê¸°</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
    <link rel="stylesheet" th:href="@{/style/style3.css}" type="text/css">
    <link rel="stylesheet" th:href="@{/css/itemDetail.css}" type="text/css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <!--    ì‹œê°„ì„¤ì •-->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"/>
    <!--  í°íŠ¸-->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jua&family=Nanum+Gothic&family=Noto+Sans+KR&display=swap"
          rel="stylesheet">
    <!--  ë³„ì -->
    <link rel="stylesheet" th:href="@{/css/star.css}" type="text/css">
</head>
<body style="background-color: white">
<th:block th:replace="commonPages/header :: header"></th:block>


<form action="#" method="get" id="loc" class="container">
    <div th:if="${item.fileAttachedItem == 1}" class="image-form">
        <!--                <th>íŒŒì¼</th>-->
        <div>
            <input type="hidden" th:value="${item.storedFileNameItem.get(0)}" name="itemImage" id="itemImage">
            <img th:src="@{|/upload/${item.storedFileNameItem.get(0)}}" alt="" width="300" height="300" id="lgImage">
        </div>
        <div th:each="fileName: ${item.storedFileNameItem}">
            <img th:src="@{|/upload/${fileName}}" alt="" width="50" height="50" class="smImage-form"
                 th:onclick="imageClick([[${fileName}]])">
        </div>
    </div>

    <div class="information">
        <div>
            <!--<th>ìƒí’ˆëª…</th>-->
            <input type="hidden" name="id" th:value="${item.id}" id="itemId">
            <input type="hidden" name="itemPrice" th:value="${item.itemPrice}">
            <input type="hidden" name="itemName" th:value="${item.itemName}">
            <h2 id="itemName" th:text="${item.itemName}"></h2>
        </div>
        <div>
            <label style="margin-right: 65px">ê°€ê²©</label>
            <input type="hidden" name="itemPrice" th:value="${item.itemPrice}">
            <p th:text="${#numbers.formatInteger(item.itemPrice,0,'COMMA')}+'ì›'" class="price-form text-form"></p>
            <!--            <p th:text="${item.itemPrice}+'ì›'" class="price-form text-form"></p>-->
        </div>
        <div>

            <div th:if="${item.itemCount == 0}">
                <label style="margin-right: 40px">êµ¬ë§¤ìˆ˜ëŸ‰</label>
                <p style="color: red; font-weight: bold;">í’ˆì ˆ</p>
            </div>
            <div th:unless="${item.itemCount == 0}">
                <label style="margin-right: 40px">êµ¬ë§¤ìˆ˜ëŸ‰</label>
                <input type="number" id="itemCountInput" min="1" max="100" value="1" name="cartCount"
                       th:onchange="total([[${item.itemCount}]])" class="text-form">
            </div>
        </div>
        <div>
            <label style="margin-right: 40px">íƒë°°ë°°ì†¡</label>
            <p class="text-form">ë¬´ë£Œë°°ì†¡</p>
        </div>
        <div style="margin-bottom: 20px;">
            <label style="margin-right: 20px">ì´ ìƒí’ˆ ê¸ˆì•¡</label>
            <div style="color: seagreen ; font-size:xx-large ; font-weight: bold" id="totalPrice" class="text-form"
                 th:text="${#numbers.formatInteger(item.itemPrice,0,'COMMA')}+'ì›'"></div>
            <!--            <div style="color: seagreen ; font-size:xx-large ; font-weight: bold" id="totalPrice" class="text-form" th:text="${item.itemPrice}+'ì›'"></div>-->
        </div>


        <div th:if="${session.member} != null">
            <div th:if="${item.itemCount != 0}">
                <input type="button" class="btn btn-outline-dark" value="ì¥ë°”êµ¬ë‹ˆ" onclick="cart()" style="float: left">
                <input type="button" class="btn btn-success" value="êµ¬ë§¤í•˜ê¸°" onclick="orderItem()" style="float: left">
            </div>
            <input type="hidden" value="loginOk" name="loginCheck">
        </div>
        <div th:unless="${session.member}">
            <div th:if="${item.itemCount != 0}">
                <input type="button" class="btn btn-outline-dark" value="ì¥ë°”êµ¬ë‹ˆ" onclick="cart()" style="float: left">
                <input type="button" class="btn btn-success" value="êµ¬ë§¤í•˜ê¸°" onclick="orderItem()" style="float: left">
            </div>
            <input type="hidden" value="loginNo" name="loginCheck">
        </div>
    </div>
</form>
<!--        </div>-->
<!--</div>-->

<div style="text-align: center; margin-top: 80px; margin-bottom: 160px">
    <!--                <th>ì„¤ëª…</th>-->
    <div style="white-space:pre;" th:text="${item.itemContents}"></div>
</div>


<div class="container mt-5" id="comment-list">
    <div th:if="${commentList == 'empty'}">
        <p>ì‘ì„±ëœ í›„ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
    </div>
    <div th:unless="${commentList == 'empty'}">
        <table class="table">
            <tr>
                <th style="padding-left: 200px;">ì£¼ë¬¸í›„ê¸°</th>
                <th style="width: 146px;">ì‘ì„±ì</th>
                <th style="width: 216px;">ì‘ì„±ì‹œê°„</th>
                <th style="width: 116px;">ë³„ì </th>
            </tr>
            <tr th:each="comment: ${commentList}">
                <input type="hidden" th:value="${comment.id}" name="commentId">
                <td th:text="${comment.commentContents}" style="padding-left: 30px;"></td>
                <td th:text="${comment.commentWriter}" class="comment-font"></td>
                <td th:text="*{#temporals.format(comment.commentCreatedDate,'yyyy-MM-dd HH:mm')}"
                    class="comment-font"></td>
                <td>
                    <div class="star-container">
                        <div th:each="num : ${#numbers.sequence(1,comment.starCount)}" class="star"></div>
                    </div>
                </td>
                <td>
                    <button th:if="${session.member != null and session.member.userId.toString().equals(comment.commentWriter)}" class="btn btn-outline-dark" th:onclick="commentUpdate([[${comment.id}]])">ìˆ˜ì •</button>
                    <button th:if="${session.member != null and session.member.userId.toString().equals(comment.commentWriter)}" class="btn btn-outline-dark" th:onclick="commentDelete([[${comment}]])">ì‚­ì œ</button>
                </td>
            </tr>
        </table>
        <div class="container text-center">
            <ul class="pagination justify-content-center">
                <li class="page-item">
                    <!--ì²«í˜ì´ì§€ ìš”ì²­ ë§í¬ /board?page=1-->
                    <a class="page-link" th:href="@{/item/(page=1,itemId=${itemId})}">
                        <span>First</span>
                    </a>
                </li>

                <li th:class="${commentList.first} ? 'disabled'" class="page-item">
                    <!--boardList.first: isFirst()
                        boardList.number: getNumber()-->
                    <a class="page-link"
                       th:href="${commentList.first} ? '#' : @{/item/(page=${commentList.number},itemId=${itemId})}">
                        <!-- ì‚¬ìš©ì 3í˜ì´ì§€, number 2 /board?page=2-->
                        <span><</span> <!-- < -->
                    </a>
                </li>

                <!-- startPage ~ endPage ê¹Œì§€ ìˆ«ìë¥¼ ë§Œë“¤ì–´ì£¼ëŠ” ì—­í•  -->
                <!--for(int page=startPage; page<=endPage; page++)-->
                <li th:each="page: ${#numbers.sequence(startPage, endPage)}"
                    th:class="${page == commentList.number + 1} ? 'page-item active'" class="page-item">
                    <a class="page-link" th:text="${page}" th:href="@{/item/(page=${page},itemId=${itemId})}"></a>
                </li>

                <!-- ë‹¤ìŒ í˜ì´ì§€ ìš”ì²­
                    í˜„ì¬ 3í˜ì´ì§€ë¥¼ ë³´ê³  ìˆë‹¤ë©´ ë‹¤ìŒ í˜ì´ì§€ëŠ” 4í˜ì´ì§€ì„.
                    getNumber() ê°’ì€ 2ì„.
                    ë”°ë¼ì„œ 4í˜ì´ì§€ë¥¼ ë³´ê³  ì‹¶ë‹¤ë©´ getNumber()+2ë¥¼ í•´ì•¼ ì»¨íŠ¸ë¡¤ëŸ¬ì— 4ë¥¼ ìš”ì²­í•  ìˆ˜ ìˆìŒ. -->
                <li th:class="${commentList.last} ? 'disabled'">
                    <a class="page-link"
                       th:href="${commentList.last} ? '#' : @{/item/(page=${commentList.number + 2},itemId=${itemId})}">
                        <span>&gt;</span>
                    </a>
                </li>

                <li class="page-item">
                    <!--ë§ˆì§€ë§‰í˜ì´ì§€ ìš”ì²­ ë§í¬-->
                    <a class="page-link" th:href="@{/item/(page=${commentList.totalPages},itemId=${itemId})}">
                        <span>Last</span>
                    </a>
                </li>
            </ul>
        </div>
    </div>
</div>
</div>
<div id="comment-page">

</div>
</body>

<script th:inline="javascript">
    //ì½”ë©˜íŠ¸ ì‚­ì œ
    const commentDelete = (comment) => {
        let id = comment.id
        let itemId = [[${item.id}]]
        if (confirm("ì •ë§ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?") == true){
            location.href = "/comment/delete?commentId=" + id + "&itemId=" + itemId
        }else {
            return false;
        }

    }


    //ì½”ë©˜íŠ¸ ìˆ˜ì •
    const commentUpdate = (commentId) => {
        console.log("ì½”ë©˜íŠ¸ì—…ë°ì´íŠ¸ ë„˜ì–´ì˜´")
        let popOption = "width=500, height=500, resizable=no, scrollbars=no, status=no;";
        console.log("íŒì—…ì°½ í˜¸ì¶œ")
        window.open("/comment/update?commentId=" + commentId, 'popup', popOption);
    }


    //ì´ë¯¸ì§€ í´ë¦­ì‹œ ì „í™˜
    const imageClick = (item) => {
        console.log(item);
        const smImage = item;
        console.log(smImage);
        console.log(smImage[0]);
        $("#lgImage").attr("src", "/upload/" + smImage);
    }

    //ì¥ë°”êµ¬ë‹ˆ
    const cart = () => {
        console.log("ì¥ë°”êµ¬ë‹ˆ í˜¸ì¶œ")
        console.log([[${item}]])
        const id = document.getElementById("itemId").value;
        const cartCount = document.getElementById("itemCountInput").value;
        const itemName = document.getElementById("itemName").textContent;
        const loginCheck = document.getElementsByName("loginCheck")[0].value;
        if (loginCheck == 'loginOk') {
            $.ajax({
                type: "get",
                url: "/cart/saved",
                data: {
                    id: id,
                    itemName: itemName,
                    cartCount: cartCount
                },
                dataType: "text",
                success: function (userId) {
                    console.log(userId);
                    if (confirm("ì¥ë°”êµ¬ë‹ˆì— ë‹´ê²¼ìŠµë‹ˆë‹¤.  ì¥ë°”êµ¬ë‹ˆë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?") == true) {
                        location.href = "/cart/list?userId=" + userId;
                    } else {
                    }
                },
                error: function () {
                    console.log("ì‹¤íŒ¨");
                }
            });
        } else {
            location.href = "/login";
        }
    }


    //ë°”ë¡œêµ¬ë§¤
    const orderItem = () => {
        console.log("orderItem í˜¸ì¶œ");
        const loc = document.getElementById("loc");
        loc.action = "/order/save";
        const form = document.querySelector('form');
        form.submit();
    }
    //êµ¬ë§¤ìˆ˜ëŸ‰
    const total = (itemCount) => {
        console.log("ìˆ˜ëŸ‰")
        const orderCount2 = document.getElementById('itemCountInput').value;
        const itemPrice2 = [[${item.itemPrice}]];
        let orderCount = orderCount2;
        let itemPrice = itemPrice2;
        let totalPrice = orderCount * itemPrice;
        let result = totalPrice.toLocaleString();
        console.log(itemCount)
        console.log(orderCount)
        if (itemCount < orderCount) {
            alert("êµ¬ë§¤ìˆ˜ëŸ‰ì„ ì´ˆê³¼í•˜ì˜€ìŠµë‹ˆë‹¤.")
            let totalPrice = itemPrice * 1;
            document.getElementById('itemCountInput').value = 1;
            document.getElementById("totalPrice").innerHTML = result + "ì›";
            // document.getElementById("totalPrice").innerHTML = totalPrice + "ì›";
        } else {
            console.log(totalPrice);
            document.getElementById("totalPrice").innerHTML = result + "ì›";
            // document.getElementById("totalPrice").innerHTML = totalPrice + "ì›";
        }
    }

    //ìµœê·¼ë³¸ìƒí’ˆì„ í˜ì´ì§€í˜¸ì¶œì‹œ ì €ì¥
    window.onload = function () {
        console.log("ìµœê·¼ë³¸ìƒí’ˆ í˜¸ì¶œ");
        const itemId = document.getElementById("itemId").value;
        const itemImage = document.getElementById("itemImage").value;
        const itemName = document.getElementById("itemName").textContent;
        const item = {
            itemId: itemId,
            itemImage: itemImage,
            itemName: itemName,
            timestamp: Date.now()
        }
        console.log(item);
        let recentItems = JSON.parse(localStorage.getItem("recentItems")) || [];
        if (recentItems.find(i => i.itemId === itemId)) return;
        recentItems.unshift(item);
        recentItems = recentItems.slice(0, 3);
        localStorage.setItem("recentItems", JSON.stringify(recentItems));
        console.log(localStorage.getItem("recentItems"));
    }


</script>
</html>